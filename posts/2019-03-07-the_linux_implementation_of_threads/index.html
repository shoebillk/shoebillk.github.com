<!doctype html><html lang=ko-kr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=theme-color content="#494f5c"><meta name=msapplication-TileColor content="#494f5c"><meta itemprop=name content="리눅스의 스레드 구현 살펴보기 - 리눅스는 스레드를 일반 프로세스로 구현한다"><meta itemprop=description content="&ldquo;리눅스는 스레드를 일반 프로세스로 구현한다.&rdquo; 라는 문구의 의미에 대해 좀더 깊이 살펴보고 어떤 의미를 가지는지 확인해 본다. 책 &l"><meta itemprop=datePublished content="2019-03-07T00:00:00+00:00"><meta itemprop=dateModified content="2019-03-07T00:00:00+00:00"><meta itemprop=wordCount content="1208"><meta itemprop=keywords content="linux_kernel,linux,"><meta property="og:title" content="리눅스의 스레드 구현 살펴보기 - 리눅스는 스레드를 일반 프로세스로 구현한다"><meta property="og:description" content="&ldquo;리눅스는 스레드를 일반 프로세스로 구현한다.&rdquo; 라는 문구의 의미에 대해 좀더 깊이 살펴보고 어떤 의미를 가지는지 확인해 본다. 책 &l"><meta property="og:type" content="article"><meta property="og:url" content="https://byounghoonkim.github.io/posts/2019-03-07-the_linux_implementation_of_threads/"><meta property="article:published_time" content="2019-03-07T00:00:00+00:00"><meta property="article:modified_time" content="2019-03-07T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="리눅스의 스레드 구현 살펴보기 - 리눅스는 스레드를 일반 프로세스로 구현한다"><meta name=twitter:description content="&ldquo;리눅스는 스레드를 일반 프로세스로 구현한다.&rdquo; 라는 문구의 의미에 대해 좀더 깊이 살펴보고 어떤 의미를 가지는지 확인해 본다. 책 &l"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color><link rel="shortcut icon" href=/favicon.ico><title>리눅스의 스레드 구현 살펴보기 - 리눅스는 스레드를 일반 프로세스로 구현한다</title><link rel=stylesheet href=https://byounghoonkim.github.io/css/style.min.adb4e738c83b4cc0eea8000ca83f72188a2ac1fd188a1e6f7cea8a7fa75cd7b1.css integrity="sha256-rbTnOMg7TMDuqAAMqD9yGIoqwf0Yih5vfOqKf6dc17E=" crossorigin=anonymous></head><body id=page><header id=site-header class="animated slideInUp faster"><div class="hdr-wrapper section-inner"><div class=hdr-left><div class=site-branding><a href=https://byounghoonkim.github.io>BH Kim's blog</a></div><nav class="site-nav hide-in-mobile"><a href=https://byounghoonkim.github.io/posts/>Posts</a>
<a href=https://byounghoonkim.github.io/about>About</a></nav></div><div class="hdr-right hdr-icons"><span class="hdr-social hide-in-mobile"><a href=https://github.com/byounghoonkim target=_blank rel="noopener me" title=Github><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a href=https://www.linkedin.com/in/%EB%B3%91%ED%9B%88-%EA%B9%80-6608638b/ target=_blank rel="noopener me" title=Linkedin><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a><a href=mailto:blue021@gmail.com target=_blank rel="noopener me" title=Email><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></span><button id=menu-btn class=hdr-btn><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div></div></header><div id=mobile-menu class="animated fast"><ul><li><a href=https://byounghoonkim.github.io/posts/>Posts</a></li><li><a href=https://byounghoonkim.github.io/about>About</a></li></ul></div><main class="site-main section-inner animated fadeIn faster"><article class=thin><header class=post-header><div class=post-meta><span>Mar 7, 2019</span></div><h1>리눅스의 스레드 구현 살펴보기 - 리눅스는 스레드를 일반 프로세스로 구현한다</h1></header><div class=content><p>&ldquo;리눅스는 스레드를 일반 프로세스로 구현한다.&rdquo; 라는 문구의 의미에 대해 좀더 깊이 살펴보고 어떤 의미를 가지는지 확인해 본다.</p><p>책 &lt;리눅스 커널 심층 분석>의 리눅스 스레드 구현 이라는 장에는 아래와 같은 설명이 나온다.</p><blockquote><p>The Linux Implementation of Threads
&mldr;
Linux has a unique implementation of threads.
To the Linux kernel, there is no concept of a thread.
Linux implements all threads as standard processes.
The Linux kernel does not provide any special scheduling semantics or data structures to represent threads.
Instead, a thread is merely a process that shares certain resources with other processes.
Each thread has a unique task_struct and appears to the kernel as a normal process—
threads just happen to share resources, such as an address space, with other processes.
This approach to threads contrasts greatly with operating systems such as Microsoft
Windows or Sun Solaris, which have explicit kernel support for threads (and sometimes
call threads lightweight processes).The name “lightweight process” sums up the difference in
philosophies between Linux and other systems.To these other operating systems, threads
are an abstraction to provide a lighter, quicker execution unit than the heavy process.To
Linux, threads are simply a manner of sharing resources between processes (which are
already quite lightweight). For example, assume you have a process that consists of four
threads. On systems with explicit thread support, one process descriptor might exist that,
in turn, points to the four different threads.The process descriptor describes the shared
resources, such as an address space or open files.The threads then describe the resources
they alone possess. Conversely, in Linux, there are simply four processes and thus four
normal task_struct structures.The four processes are set up to share certain resources.
The result is quite elegant
&mldr;</p></blockquote><p>스레드라는 개념을 명시적으로 구현한 윈도우나 솔라리스 등의 운영체제와는 달리
리눅스에서의 스레드 구현은 단지 프로세스 간에 리소스를 공유 하는 형태로 구현한다고 설명한다.</p><p>리눅스에서는 스레드를 생성할 때 스레드 생성과 관련된 명시적인 커널 API(윈도우의 경우 PsCreateSystemThread 와 같은)를
호출하는 것이 대신 프로세스를 클론하고 클론된 프로세스에서 클론한 프로세스의 리소스를 공유하는 형태로 구현한다.</p><p>코드로 알아 보기 위해 아래와 같은 스레드 생성 코드를 작성했다.</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;pthread.h&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=k>static</span> <span class=kt>void</span><span class=o>*</span> <span class=nf>thread</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>arg</span><span class=p>)</span>
<span class=p>{</span>
	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;sleeping... 100 seconds...</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
	<span class=n>sleep</span><span class=p>(</span><span class=mi>100</span><span class=p>);</span>
	<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>

<span class=kt>void</span> <span class=nf>main</span><span class=p>()</span> 
<span class=p>{</span>
	<span class=n>pthread_t</span> <span class=n>tid</span><span class=p>;</span>
	<span class=kt>int</span> <span class=n>ret</span><span class=p>;</span>
	<span class=kt>void</span> <span class=o>*</span><span class=n>res</span><span class=p>;</span>

	<span class=n>ret</span> <span class=o>=</span> <span class=n>pthread_create</span><span class=p>(</span><span class=o>&amp;</span><span class=n>tid</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=o>&amp;</span><span class=kr>thread</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
	<span class=n>printf</span><span class=p>(</span><span class=s>&#34;waiting... </span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
	<span class=n>ret</span> <span class=o>=</span> <span class=n>pthread_join</span><span class=p>(</span><span class=n>tid</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>res</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><p>위 코드를 컴파일(gcc main.c -lpthread)한 후 strace를 통해 실행하면
아래와 같이 pthread_create 호출 시 clone API 를 호출하는 것을 확인할 수 있다.
(좀더 자세한 사항은 man clone(2) 의 CLONE_THREAD 부분을 참고하기 바란다.)</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>&gt; strace ./a.out
...
brk<span class=o>(</span>NULL<span class=o>)</span>                               <span class=o>=</span> 0x55966b82a000
brk<span class=o>(</span>0x55966b84b000<span class=o>)</span>                     <span class=o>=</span> 0x55966b84b000
clone<span class=o>(</span><span class=nv>child_stack</span><span class=o>=</span>0x7f306daeffb0, <span class=nv>flags</span><span class=o>=</span>CLONE_VM<span class=p>|</span>CLONE_FS<span class=p>|</span>CLONE_FILES<span class=p>|</span>CLONE_SIGHAND<span class=p>|</span>CLONE_THREAD<span class=p>|</span>CLONE_SYSVSEM<span class=p>|</span>CLONE_SETTLS<span class=p>|</span>CLONE_PARENT_SETTID<span class=p>|</span>CLONE_CHILD_CLEARTID, parent_
<span class=nv>tidptr</span><span class=o>=</span>0x7f306daf09d0, <span class=nv>tls</span><span class=o>=</span>0x7f306daf0700, <span class=nv>child_tidptr</span><span class=o>=</span>0x7f306daf09d0<span class=o>)</span> <span class=o>=</span> <span class=m>2126</span>                                                                                              
futex<span class=o>(</span>0x7f306dede8c0, FUTEX_WAIT_PRIVATE, 2, NULLsleeping... <span class=m>100</span> seconds...
<span class=o>)</span> <span class=o>=</span> <span class=m>0</span>
write<span class=o>(</span>1, <span class=s2>&#34;waiting... \n&#34;</span>, 12waiting... 
...
</code></pre></div><p>간단하게 나마 리눅스 커널에서는 스레드라는 것이 다른 프로세스의 리소스를 공유하는 프로세스라는 점을 알아 보았다. 그럼 유저 모드에서는 그 영향이 나타날까? thread id 라는 것이 process id 와 동일할 것일까?</p><p>위에서 작성한 프로그램을 백그라운드로 실행한다(./a.out &).
그리고 thread 에 관한 정보를 출력하기 위해 ps 명령에 -Lf 옵션을 주어 실행한다.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>&gt; ./a.out <span class=p>&amp;</span>
<span class=o>[</span>1<span class=o>]</span> <span class=m>4308</span>
waiting... 
sleeping... <span class=m>100</span> seconds...

&gt; ps -Lf
UID        PID  PPID   LWP  C NLWP STIME TTY          TIME CMD
...
bhkim     <span class=m>4308</span>  <span class=m>2028</span>  <span class=m>4308</span>  <span class=m>0</span>    <span class=m>2</span> 23:02 pts/4    00:00:00 ./a.out
bhkim     <span class=m>4308</span>  <span class=m>2028</span>  <span class=m>4310</span>  <span class=m>0</span>    <span class=m>2</span> 23:02 pts/4    00:00:00 ./a.out
...

</code></pre></div><p>ps의 출력 정보 중 PID 4308 이라는 항목으로 두줄의 정보가 나온다.
thread id 정도가 있어야 할 자리에 LWP ID가 출력된다.
첫번째 줄의 LWP 항목은 자신의 PID 와 동일한 값을 가진다.
그리고 두번째 줄의 LWP 항목은 4310 의 값을 가진다.
LWP는 light wight process의 약자로 리눅스 커널이 스레드를 프로세스로 구현함으로 인해 나타난 증상이라고 볼 수 있다.</p><p>LWP 항목은 실제로 PID 의 대용으로 사용할 수 있다.
예를 들면, kill 4310 과 같은 명령으로 LWP 4310 인 프로세스를 종료할 수도 있다.</p><p>요약,</p><ol><li>리눅스 커널은 스레드를 프로세스를 이용해 구현한다.</li><li>LWP 라는 이름은 리눅스의 스레드 구현에 기인한 산물이다.</li><li>리눅스의 커널 구현은 스레드를 명시적으로 구현하는 다른 운영체제와 대조된다.</li></ol></div><hr class=post-end><footer class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://byounghoonkim.github.io/tags/linux_kernel>linux_kernel</a></span><span class=tag><a href=https://byounghoonkim.github.io/tags/linux>linux</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2019-03-07 00:00 +0000</p></footer></article><div class="post-nav thin"><a class=next-post href=https://byounghoonkim.github.io/posts/building_golang_using_docker/><span class=post-nav-label><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>&nbsp;</span><br><span>Docker로 Golang 프로젝트 빌드 하기</span></a>
<a class=prev-post href=https://byounghoonkim.github.io/posts/2015-02-13-vim-holy-grail-esc-ctrl-bracke-and-jk/><span class=post-nav-label>&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></span><br><span>Vi의 Esc 기원</span></a></div><div id=comments class=thin><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"bh-kims-blog"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></main><footer id=site-footer class="section-inner thin animated fadeIn faster"><p>&copy; 2020 <a href=https://byounghoonkim.github.io></a>&#183; <a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></p><p>Made with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> &#183; Theme <a href=https://github.com/Track3/hermit target=_blank rel=noopener>Hermit</a> &#183; <a href=https://byounghoonkim.github.io/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></p></footer><script src=https://byounghoonkim.github.io/js/bundle.min.4a9a0ac3d2217822c7865b4161e6c2a71de1d70492264337755427898dd718f6.js integrity="sha256-SpoKw9IheCLHhltBYebCpx3h1wSSJkM3dVQniY3XGPY=" crossorigin=anonymous></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-48905340-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>